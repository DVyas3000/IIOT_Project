<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Control System</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap"
      rel="stylesheet"
    />
    <!-- Include MQTT.js library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  </head>
  <body>
    <!-- Landing Page -->
    <div id="landing-page">
      <h1>INDOOR CLIMATE CONTROL SYSTEM</h1>
      <p>Advanced monitoring and control system</p>
      <button id="start-button">INITIALIZE SYSTEM</button>
    </div>

    <!-- Mode Selection -->
    <div id="mode-selection">
      <h2 style="color: #0ff; font-size: 2.5rem; margin-bottom: 2rem">
        SELECT OPERATION MODE
      </h2>
      <button class="mode-btn" id="manual-mode">MANUAL CONTROL</button>
      <button class="mode-btn" id="auto-mode">AUTOMATED SYSTEM</button>
    </div>

    <!-- Weather Control Navigation -->
    <div id="circle-nav">
      <div class="circle-center">
        <div class="center-text">Controls</div>
        <div class="center-glow"></div>
      </div>
      <a href="#" class="circle-link" data-section="ac-control">
        <span>AC</span>
        <div class="link-glow"></div>
      </a>
      <a href="#" class="circle-link" data-section="fan-control">
        <span>Fan</span>
        <div class="link-glow"></div>
      </a>
      <a href="#" class="circle-link" data-section="window-control">
        <span>Window</span>
        <div class="link-glow"></div>
      </a>
      <a href="#" class="circle-link" data-section="stats">
        <span>Stats</span>
        <div class="link-glow"></div>
      </a>
      <!-- <a href="#" class="circle-link" data-section="automated-mode">
      <span>Auto Mode</span>
      <div class="link-glow"></div>
    </a> -->
      <a
        href="#"
        class="circle-link menu-back-button"
        data-section="mode-selection"
      >
        <span>← BACK</span>
        <div class="link-glow"></div>
      </a>
    </div>

    <!-- Weather Control Sections -->
    <div id="content">
      <!-- AC Control Section -->
      <section id="ac-control" class="section">
        <button class="back-button">← BACK</button>
        <div class="section-content">
          <h2>Air Conditioning Control</h2>
          <div class="control-panel">
            <div class="toggle-container" style="justify-content: center">
              <button class="cool-toggle on">POWER ON / UPDATE</button>
              <button class="cool-toggle off">POWER OFF</button>
            </div>

            <label
              style="
                color: #0ff;
                display: block;
                text-align: center;
                margin-top: 1.5rem;
              "
              >Temperature Control</label
            >
            <input
              type="range"
              min="19"
              max="25"
              value="22"
              class="slider"
              id="temp-slider"
            />
            <div
              style="display: flex; justify-content: space-between; color: #0ff"
            >
              <span>19°C</span>
              <span id="temp-value">22°C</span>
              <span>25°C</span>
            </div>

            <!-- <label style="color: #0ff; display: block; text-align: center; margin-top: 1.5rem;">Mode Selection</label>
          <div class="toggle-container" style="justify-content: center; flex-wrap: wrap;">
            <button class="cool-toggle on">COOL</button>
            <button class="cool-toggle off">HEAT</button>
            <button class="cool-toggle off">FAN</button>
            <button class="cool-toggle off">DRY</button>
          </div> -->

            <!-- <label style="color: #0ff; display: block; text-align: center; margin-top: 1.5rem;">Fan Speed</label>
          <div class="toggle-container" style="justify-content: center;">
            <button class="cool-toggle off">LOW</button>
            <button class="cool-toggle on">MID</button>
            <button class="cool-toggle off">HIGH</button>
            <button class="cool-toggle off">AUTO</button>
          </div> -->

            <div style="text-align: center; margin-top: 2rem">
              <div class="status-indicator on"></div>
              <p style="color: #0ff; margin-top: 0.5rem">System Active</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Fan Control Section -->
      <section id="fan-control" class="section">
        <button class="back-button">← BACK</button>
        <div class="section-content">
          <h2>Fan Control</h2>
          <div class="control-panel">
            <label style="color: #0ff; display: block; text-align: center"
              >Fan Status</label
            >
            <div
              class="toggle-container"
              style="justify-content: center; margin: 2rem 0"
            >
              <button class="cool-toggle on">POWER ON</button>
              <button class="cool-toggle off">POWER OFF</button>
            </div>

            <!-- <label style="color: #0ff; display: block; text-align: center; margin-top: 1.5rem;">Oscillation</label>
          <div class="toggle-container" style="justify-content: center;">
            <button class="cool-toggle on">ON</button>
            <button class="cool-toggle off">OFF</button>
          </div> -->

            <!-- <label style="color: #0ff; display: block; text-align: center; margin-top: 1.5rem;">Mode</label>
          <div class="toggle-container" style="justify-content: center;">
            <button class="cool-toggle on">NORMAL</button>
            <button class="cool-toggle off">NATURAL</button>
            <button class="cool-toggle off">SLEEP</button>
          </div> -->

            <div style="text-align: center; margin-top: 2rem">
              <div class="status-indicator on"></div>
              <p style="color: #0ff; margin-top: 0.5rem">Fan Active</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Window Control Section -->
      <section id="window-control" class="section">
        <button class="back-button">← BACK</button>
        <div class="section-content">
          <h2>Window Control</h2>
          <div class="control-panel">
            <label style="color: #0ff; display: block; text-align: center"
              >Window Status</label
            >
            <div
              class="toggle-container"
              style="justify-content: center; margin: 2rem 0"
            >
              <button class="cool-toggle on">OPEN</button>
              <button class="cool-toggle off">CLOSED</button>
            </div>
            <!--           
          <label style="color: #0ff; display: block; text-align: center;">Opening Percentage</label>
          <input type="range" min="0" max="100" value="75" class="slider" id="window-slider">
          <div style="display: flex; justify-content: space-between; color: #0ff;">
            <span>0%</span>
            <span id="window-value">75%</span>
            <span>100%</span>
          </div>
           -->
            <!-- <label style="color: #0ff; display: block; text-align: center; margin-top: 1.5rem;">Ventilation Mode</label>
          <div class="toggle-container" style="justify-content: center;">
            <button class="cool-toggle on">MANUAL</button>
            <button class="cool-toggle off">SCHEDULED</button>
            <button class="cool-toggle off">SMART</button>
          </div> -->

            <div style="text-align: center; margin-top: 2rem">
              <div class="status-indicator on"></div>
              <p style="color: #0ff; margin-top: 0.5rem">Window Active</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Statistics Section -->
      <section id="stats" class="section">
        <button class="back-button">← BACK</button>
        <div class="section-content">
          <h2>System Statistics</h2>
          <div class="control-panel">
            <div class="sensor-grid">
              <div class="sensor-item">
                <div class="sensor-label">Temperature</div>
                <div class="sensor-value" id="stats-temperature">--°C</div>
                <div class="status-indicator on small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">Humidity</div>
                <div class="sensor-value" id="stats-humidity">--%</div>
                <div class="status-indicator on small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">CO² Level</div>
                <div class="sensor-value" id="stats-co2">-- ppm</div>
                <div class="status-indicator off small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">Occupancy</div>
                <div class="sensor-value" id="stats-occupancy">-- people</div>
                <div class="status-indicator on small"></div>
              </div>
            </div>

            <!-- <h3 style="color: #0ff; text-align: center; margin-top: 2rem;">Device Status</h3>
      <div class="device-status">
        <div class="status-item">
          <div class="status-indicator on small"></div>
          <span style="color: #0ff;">AC: ON</span>
        </div>
        <div class="status-item">
          <div class="status-indicator on small"></div>
          <span style="color: #0ff;">Fan: ON</span>
        </div>
        <div class="status-item">
          <div class="status-indicator off small"></div>
          <span style="color: #0ff;">Window: CLOSED</span>
        </div>
      </div> -->
          </div>
        </div>
      </section>

      <!-- Automated Mode Section -->
      <section id="automated-mode" class="section">
        <button class="auto-back-button">← BACK</button>
        <div class="section-content">
          <h2>Automated Climate Control</h2>
          <div class="control-panel">
            <div class="sensor-grid">
              <div class="sensor-item">
                <div class="sensor-label">Temperature</div>
                <div class="sensor-value">--°C</div>
                <div class="status-indicator on small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">Humidity</div>
                <div class="sensor-value">--%</div>
                <div class="status-indicator on small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">CO² Level</div>
                <div class="sensor-value">-- ppm</div>
                <div class="status-indicator off small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">Occupancy</div>
                <div class="sensor-value" id="automated-occupancy">
                  -- people
                </div>
                <div class="status-indicator on small"></div>
              </div>
            </div>

            <h3 style="color: #0ff; text-align: center; margin-top: 2rem">
              Device Status
            </h3>
            <div class="sensor-grid">
              <div class="sensor-item">
                <div class="sensor-label">AC</div>
                <div class="sensor-value">ON</div>
                <div class="status-indicator on small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">Fan</div>
                <div class="sensor-value">ON</div>
                <div class="status-indicator on small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">Window</div>
                <div class="sensor-value">CLOSED</div>
                <div class="status-indicator off small"></div>
              </div>
              <div class="sensor-item">
                <div class="sensor-label">System</div>
                <div class="sensor-value">ACTIVE</div>
                <div class="status-indicator on small"></div>
              </div>
            </div>

            <h3 style="color: #0ff; text-align: center; margin-top: 2rem">
              Automation Settings
            </h3>
            <div class="sensor-grid" style="grid-template-columns: 1fr">
              <div class="sensor-item">
                <div class="sensor-label">Target Temperature</div>
                <input
                  type="range"
                  min="19"
                  max="25"
                  value="22"
                  class="slider"
                  id="auto-temp-slider"
                  style="margin: 1rem 0"
                />
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    color: #0ff;
                  "
                >
                  <span>19°C</span>
                  <span id="auto-temp-value">22°C</span>
                  <span>25°C</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="temp-display">Loading...</div>

    <script>
      // function updateSensorData() {
      //   fetch("https://api.thingspeak.com/channels/2895649/feeds/last.json?api_key=FJPVWSKWQHVQOKT2")
      //     .then(response => response.json())
      //     .then(data => {
      //       console.log("Received data:", data); // Debugging

      //       // Parse sensor values
      //       const temperature = parseFloat(data.field1);
      //       const humidity = parseFloat(data.field2);
      //       const co2 = parseFloat(data.field3);
      //       const occupancy = parseInt(data.field4);

      //       // Update displayed values
      //       if (data.field1) {
      //         const tempValue = `${temperature}°C`;
      //         document.getElementById("stats-temperature").textContent = tempValue;
      //         document.querySelector("#automated-mode .sensor-item:nth-child(1) .sensor-value").textContent = tempValue;
      //       }
      //       if (data.field2) {
      //         const humidityValue = `${humidity}%`;
      //         document.getElementById("stats-humidity").textContent = humidityValue;
      //         document.querySelector("#automated-mode .sensor-item:nth-child(2) .sensor-value").textContent = humidityValue;
      //       }
      //       if (data.field3) {
      //         const co2Value = `${co2} ppm`;
      //         document.getElementById("stats-co2").textContent = co2Value;
      //         document.querySelector("#automated-mode .sensor-item:nth-child(3) .sensor-value").textContent = co2Value;
      //       }
      //       if (data.field4 && data.field4.trim() !== "") {
      //           document.getElementById("stats-occupancy").textContent = `${data.field4} People`;
      //           document.getElementById("automated-occupancy").textContent = `${data.field4} People`;
      //         }

      //       // Implement automation rules
      //       if (occupancy === 0) {
      //         // If no people, turn everything off
      //         setDeviceStatus('ac', 'OFF');
      //         setDeviceStatus('fan', 'OFF');
      //         setDeviceStatus('window', 'CLOSED');
      //       } else if (temperature > 28) {
      //         // High temperature: AC on, others off
      //         setDeviceStatus('ac', 'ON');
      //         setDeviceStatus('fan', 'OFF');
      //         setDeviceStatus('window', co2 > 150 ? 'OPEN' : 'CLOSED');
      //       } else if (temperature < 23) {
      //         // Low temperature: AC and fan off
      //         setDeviceStatus('ac', 'OFF');
      //         setDeviceStatus('fan', 'OFF');
      //         setDeviceStatus('window', co2 > 150 ? 'OPEN' : 'CLOSED');
      //       } else {
      //         // Moderate temperature (23-28): Fan on, AC off
      //         setDeviceStatus('ac', 'OFF');
      //         setDeviceStatus('fan', 'ON');
      //         setDeviceStatus('window', co2 > 150 ? 'OPEN' : 'CLOSED');
      //       }
      //     })
      //     .catch(error => {
      //       console.error("ThingSpeak fetch error:", error);
      //     });
      // }

      // Helper function to update device status in the UI
      function setDeviceStatus(device, status) {
        // Update in stats section
        const statElement = document.querySelector(
          `#stats .device-status .status-item:nth-child(${
            device === "ac" ? 1 : device === "fan" ? 2 : 3
          })`
        );

        if (statElement) {
          statElement.querySelector(
            ".status-indicator"
          ).className = `status-indicator ${
            status === "ON" || status === "OPEN" ? "on" : "off"
          } small`;
          statElement.querySelector(
            "span"
          ).textContent = `${device.toUpperCase()}: ${status}`;
        }

        // Update in automated mode section
        const autoElement = document.querySelector(
          `#automated-mode .sensor-grid:nth-of-type(2) .sensor-item:nth-child(${
            device === "ac" ? 1 : device === "fan" ? 2 : 3
          })`
        );

        if (autoElement) {
          autoElement.querySelector(
            ".status-indicator"
          ).className = `status-indicator ${
            status === "ON" || status === "OPEN" ? "on" : "off"
          } small`;
          autoElement.querySelector(".sensor-value").textContent = status;
        }

        //   // Here you would also add code to actually control the physical devices
        //   // via MQTT or other IoT protocol
      }

      // Update immediately on page load
      // document.addEventListener("DOMContentLoaded", function() {
      //   console.log("DOM loaded, updating sensor data");
      //   updateSensorData();
      //   // Then update every 15 seconds (ThingSpeak's free tier rate limit)
      //   setInterval(updateSensorData, 15000);
      // });
      //
    </script>

    <script>
      // MQTT Connection (WebSocket port)
      const client = mqtt.connect("wss://iot-team46.duckdns.org:9001");

      // Helper to publish control messages
      function sendCommand(topic, message) {
        if (client.connected) {
          client.publish(topic, message);
          console.log(`Sent to ${topic}: ${message}`);
          updateUIStatus(topic, message); // Update UI immediately
        } else {
          console.warn("MQTT not connected");
        }
      }

      // Update UI elements when sending commands
      function updateUIStatus(topic, message) {
        const device = topic.split("/")[1];
        const status = message.toLowerCase();

        // Update status indicators
        document.querySelectorAll(`.status-item`).forEach((item) => {
          if (item.textContent.includes(device.toUpperCase())) {
            const indicator = item.querySelector(".status-indicator");
            indicator.classList.toggle(
              "on",
              status === "on" || status === "open"
            );
            indicator.classList.toggle(
              "off",
              !(status === "on" || status === "open")
            );
            item.querySelector(
              "span"
            ).textContent = `${device.toUpperCase()}: ${message.toUpperCase()}`;
          }
        });
      }
      
      // Set up global mode tracking
      window.isAutomaticMode = false;
      
      // Initialize mode selection handlers
      document.addEventListener("DOMContentLoaded", function() {
        const manualModeBtn = document.getElementById("manual-mode");
        const autoModeBtn = document.getElementById("auto-mode");
        
        if (manualModeBtn) {
          manualModeBtn.addEventListener("click", function() {
            window.isAutomaticMode = false;
            console.log("Manual mode activated");
          });
        }
        
        if (autoModeBtn) {
          autoModeBtn.addEventListener("click", function() {
            window.isAutomaticMode = true;
            console.log("Automatic mode activated");
            // Show the automated mode section
            document.getElementById("automated-mode").style.display = "block";
          });
        }
        
        // Automated control bindings - removed the isAutomaticMode check
        const autoTempSlider = document.getElementById("auto-temp-slider");
        if (autoTempSlider) {
          autoTempSlider.addEventListener("input", (e) => {
            const temp = e.target.value;
            document.getElementById("auto-temp-value").textContent = `${temp}°C`;
            sendCommand("controls/ac/temp", temp);
            console.log("Auto temp slider updated:", temp);
          });
        }
      });
      
      // Manual Control Bindings
      document.addEventListener("DOMContentLoaded", function () {
        // AC Control
        document
          .querySelector("#ac-control .cool-toggle.on")
          .addEventListener("click", () => {
            // if (!window.isAutomaticMode) sendCommand("controls/ac", "on");
          });
        document
          .querySelector("#ac-control .cool-toggle.off")
          .addEventListener("click", () => {
            if (!window.isAutomaticMode) sendCommand("controls/ac", "0");
          });
        document
          .getElementById("temp-slider")
          .addEventListener("input", (e) => {
            if (!window.isAutomaticMode) {
              const temp = e.target.value;
              document.getElementById("temp-value").textContent = `${temp}°C`;
              sendCommand("controls/ac/temp", temp);
            }
          });

        // Fan Control
        document
          .querySelector("#fan-control .cool-toggle.on")
          .addEventListener("click", () => {
            if (!window.isAutomaticMode) sendCommand("controls/fan", "on");
          });
        document
          .querySelector("#fan-control .cool-toggle.off")
          .addEventListener("click", () => {
            if (!window.isAutomaticMode) sendCommand("controls/fan", "off");
          });
        
        // Check if fan-speed-slider exists
        const fanSpeedSlider = document.getElementById("fan-speed-slider");
        if (fanSpeedSlider) {
          fanSpeedSlider.addEventListener("input", (e) => {
            if (!window.isAutomaticMode) {
              const speed = e.target.value;
              document.getElementById(
                "fan-speed-value"
              ).textContent = `Speed (${speed})`;
              sendCommand("controls/fan/speed", speed);
            }
          });
        }

        // Window Control
        document
          .querySelector("#window-control .cool-toggle.on")
          .addEventListener("click", () => {
            if (!window.isAutomaticMode) sendCommand("controls/window", "open");
          });
        document
          .querySelector("#window-control .cool-toggle.off")
          .addEventListener("click", () => {
            if (!window.isAutomaticMode)
              sendCommand("controls/window", "closed");
          });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Toggle button active states
        document.querySelectorAll(".cool-toggle").forEach((button) => {
          button.addEventListener("click", function (e) {
            // Remove active state from siblings
            const container = e.target.closest(".toggle-container");
            container.querySelectorAll(".cool-toggle").forEach((btn) => {
              btn.classList.remove("on");
              btn.classList.add("off");
            });

            // Set clicked button active
            e.target.classList.add("on");
            e.target.classList.remove("off");

            // Update circle nav glow
            const sectionId = container.closest(".section").id;
            const circleLink = document.querySelector(
              `.circle-link[data-section="${sectionId}"]`
            );
            if (circleLink) {
              circleLink.classList.toggle(
                "active",
                e.target.classList.contains("on")
              );
            }
          });
        });

        // Initialize default states
        document.querySelectorAll(".cool-toggle.on").forEach((btn) => {
          btn.classList.add("on");
          const sectionId = btn.closest(".section").id;
          document
            .querySelector(`.circle-link[data-section="${sectionId}"]`)
            ?.classList.add("active");
        });
        
        // Back button for automated mode
        const autoBackBtn = document.querySelector(".auto-back-button");
        if (autoBackBtn) {
          autoBackBtn.addEventListener("click", function() {
            document.getElementById("automated-mode").style.display = "none";
            document.getElementById("mode-selection").style.display = "flex";
          });
        }
      });
    </script>

    <script src="script.js"></script>
  </body>
</html>